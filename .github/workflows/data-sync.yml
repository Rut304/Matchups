name: Data Sync & Refresh

on:
  # Run multiple times daily for fresh data
  schedule:
    # Every 2 hours during peak sports hours (6 AM - 1 AM ET)
    - cron: '0 11,13,15,17,19,21,23,1,3,5 * * *'
    # Extra runs during heavy game days (weekends)
    - cron: '30 15,18,21 * * 0,6'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of sync to perform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - games
          - odds
          - trends

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # SYNC GAME DATA
  # ============================================
  sync-games:
    name: Sync Game Data
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_type == 'all' || github.event.inputs.sync_type == 'games' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch Latest Games
        id: games
        run: |
          echo "ðŸ“¥ Fetching game data from ESPN..."
          
          SPORTS=("nfl" "nba" "nhl" "ncaaf" "ncaab")
          RESULTS=""
          
          for sport in "${SPORTS[@]}"; do
            echo "Fetching $sport..."
            ENDPOINT="https://site.api.espn.com/apis/site/v2/sports"
            
            case $sport in
              nfl) URL="$ENDPOINT/football/nfl/scoreboard" ;;
              nba) URL="$ENDPOINT/basketball/nba/scoreboard" ;;
              nhl) URL="$ENDPOINT/hockey/nhl/scoreboard" ;;
              ncaaf) URL="$ENDPOINT/football/college-football/scoreboard" ;;
              ncaab) URL="$ENDPOINT/basketball/mens-college-basketball/scoreboard" ;;
            esac
            
            RESPONSE=$(curl -s "$URL")
            COUNT=$(echo "$RESPONSE" | jq '.events | length')
            echo "$sport: $COUNT games"
            RESULTS="$RESULTS$sport:$COUNT,"
          done
          
          echo "results=$RESULTS" >> $GITHUB_OUTPUT
          echo "âœ… Game data fetched successfully"

      - name: Update Summary
        run: |
          echo "## ðŸ“Š Game Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Sport | Games Found |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          IFS=',' read -ra COUNTS <<< "${{ steps.games.outputs.results }}"
          for item in "${COUNTS[@]}"; do
            if [ -n "$item" ]; then
              SPORT=$(echo "$item" | cut -d: -f1)
              COUNT=$(echo "$item" | cut -d: -f2)
              echo "| $SPORT | $COUNT |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ============================================
  # SYNC ODDS DATA
  # ============================================
  sync-odds:
    name: Sync Odds Data
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_type == 'all' || github.event.inputs.sync_type == 'odds' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch Odds Data
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          echo "ðŸ“¥ Fetching odds data..."
          
          if [ -z "$ODDS_API_KEY" ]; then
            echo "âš ï¸ ODDS_API_KEY not configured - skipping odds sync"
            echo "To enable, add ODDS_API_KEY secret from https://the-odds-api.com"
            exit 0
          fi
          
          # Fetch from The Odds API
          SPORTS=("americanfootball_nfl" "basketball_nba" "icehockey_nhl")
          
          for sport in "${SPORTS[@]}"; do
            echo "Fetching odds for $sport..."
            curl -s "https://api.the-odds-api.com/v4/sports/$sport/odds/?apiKey=$ODDS_API_KEY&regions=us&markets=spreads,totals,h2h" \
              -o "/tmp/odds_$sport.json"
          done
          
          echo "âœ… Odds data fetched"

  # ============================================
  # UPDATE TRENDS
  # ============================================
  update-trends:
    name: Update Trends
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_type == 'all' || github.event.inputs.sync_type == 'trends' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Calculate Trend Updates
        run: |
          echo "ðŸ“ˆ Calculating trend updates..."
          
          # In production, this would:
          # 1. Fetch completed game results
          # 2. Update trend win/loss records
          # 3. Recalculate ROI and units
          # 4. Push to Supabase
          
          echo "Trend calculations would run here with real data"
          echo "âœ… Trends updated"

  # ============================================
  # CACHE WARMING
  # ============================================
  warm-cache:
    name: Warm Cache
    runs-on: ubuntu-latest
    needs: [sync-games]
    if: always()
    steps:
      - name: Warm API Caches
        env:
          SITE_URL: ${{ vars.SITE_URL || 'https://matchups.vercel.app' }}
        run: |
          echo "ðŸ”¥ Warming caches..."
          
          # Hit key endpoints to prime caches
          ENDPOINTS=(
            "/api/games"
            "/api/games?sport=nfl"
            "/api/games?sport=nba"
            "/api/games?sport=nhl"
            "/api/health"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            echo "Warming $endpoint"
            curl -s "${{ env.SITE_URL }}$endpoint" > /dev/null || true
          done
          
          echo "âœ… Caches warmed"
