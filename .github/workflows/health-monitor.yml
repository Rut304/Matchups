name: Health Monitor & Self-Healing

on:
  # Run every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_healing:
        description: 'Force healing actions even if healthy'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  SITE_URL: ${{ vars.SITE_URL || 'https://matchups.vercel.app' }}

jobs:
  # ============================================
  # HEALTH CHECK
  # ============================================
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
      unhealthy_services: ${{ steps.check.outputs.unhealthy_services }}
      needs_healing: ${{ steps.check.outputs.needs_healing }}
    steps:
      - name: Check System Health
        id: check
        run: |
          echo "ðŸ¥ Checking system health..."
          
          # Call health endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.SITE_URL }}/api/health?healing=true" || echo -e '{"status":"unreachable"}\n000')
          BODY=$(echo "$RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          # Parse status
          if [ "$HTTP_CODE" = "000" ]; then
            STATUS="unreachable"
          else
            STATUS=$(echo "$BODY" | jq -r '.status // "unknown"')
          fi
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          # Check for unhealthy services
          if [ "$STATUS" = "unhealthy" ] || [ "$STATUS" = "degraded" ] || [ "$STATUS" = "unreachable" ]; then
            echo "needs_healing=true" >> $GITHUB_OUTPUT
            
            # Extract unhealthy service names
            if [ "$HTTP_CODE" != "000" ]; then
              UNHEALTHY=$(echo "$BODY" | jq -r '.services[] | select(.status != "healthy") | .name' | tr '\n' ',' | sed 's/,$//')
              echo "unhealthy_services=$UNHEALTHY" >> $GITHUB_OUTPUT
            else
              echo "unhealthy_services=Site Unreachable" >> $GITHUB_OUTPUT
            fi
          else
            echo "needs_healing=false" >> $GITHUB_OUTPUT
            echo "unhealthy_services=" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate Health Report
        if: always()
        run: |
          echo "## ðŸ¥ Health Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.needs_healing }}" = "true" ]; then
            echo "âš ï¸ **Issues Detected:**" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.check.outputs.unhealthy_services }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All systems operational" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # SELF-HEALING ACTIONS
  # ============================================
  self-heal:
    name: Self-Healing
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.needs_healing == 'true' || github.event.inputs.force_healing == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Analyze Issues
        id: analyze
        run: |
          echo "ðŸ” Analyzing issues..."
          UNHEALTHY="${{ needs.health-check.outputs.unhealthy_services }}"
          
          # Determine actions needed
          ACTIONS=""
          
          if echo "$UNHEALTHY" | grep -qi "ESPN"; then
            ACTIONS="$ACTIONS,retry_espn"
          fi
          
          if echo "$UNHEALTHY" | grep -qi "Supabase"; then
            ACTIONS="$ACTIONS,check_supabase"
          fi
          
          if echo "$UNHEALTHY" | grep -qi "Internal API\|Unreachable"; then
            ACTIONS="$ACTIONS,redeploy"
          fi
          
          echo "actions=$ACTIONS" >> $GITHUB_OUTPUT
          echo "Actions to take: $ACTIONS"

      - name: Retry ESPN APIs
        if: contains(steps.analyze.outputs.actions, 'retry_espn')
        run: |
          echo "ðŸ”„ Retrying ESPN API connections..."
          
          # Test each endpoint with retries
          ENDPOINTS=(
            "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard"
            "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard"
            "https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            for i in 1 2 3; do
              echo "Attempt $i for $endpoint"
              if curl -s --max-time 10 "$endpoint" | jq -e '.events' > /dev/null 2>&1; then
                echo "âœ… Success"
                break
              fi
              sleep 5
            done
          done

      - name: Check Supabase
        if: contains(steps.analyze.outputs.actions, 'check_supabase')
        run: |
          echo "ðŸ” Checking Supabase connection..."
          # We can't directly fix Supabase, but we can verify the issue
          # and switch to mock data mode if needed
          
          echo "Supabase issues detected - app should automatically fall back to mock data"

      - name: Trigger Redeployment
        if: contains(steps.analyze.outputs.actions, 'redeploy')
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ðŸš€ Triggering redeployment..."
          
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "âš ï¸ VERCEL_TOKEN not configured - cannot redeploy"
            echo "To enable auto-redeploy, add VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID secrets"
            exit 0
          fi
          
          # Trigger Vercel redeploy
          curl -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"matchups\",
              \"project\": \"$VERCEL_PROJECT_ID\",
              \"target\": \"production\",
              \"gitSource\": {
                \"type\": \"github\",
                \"ref\": \"main\",
                \"repoId\": \"${{ github.repository_id }}\"
              }
            }"

      - name: Post-Healing Verification
        id: verify
        run: |
          echo "âœ… Verifying healing actions..."
          sleep 30  # Wait for any deployments or caches to clear
          
          # Re-check health
          RESPONSE=$(curl -s "${{ env.SITE_URL }}/api/health" || echo '{"status":"unreachable"}')
          STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "New status: $STATUS"

      - name: Update Summary
        run: |
          echo "## ðŸ”§ Self-Healing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Original Issues:** ${{ needs.health-check.outputs.unhealthy_services }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actions Taken:** ${{ steps.analyze.outputs.actions }}" >> $GITHUB_STEP_SUMMARY
          echo "**Post-Healing Status:** ${{ steps.verify.outputs.status }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ALERT ON PERSISTENT ISSUES
  # ============================================
  alert:
    name: Alert on Issues
    runs-on: ubuntu-latest
    needs: [health-check, self-heal]
    if: always() && needs.health-check.outputs.needs_healing == 'true'
    steps:
      - name: Create Issue for Persistent Problems
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.health-check.outputs.status }}';
            const unhealthy = '${{ needs.health-check.outputs.unhealthy_services }}';
            
            // Only create issue for critical failures
            if (status !== 'unhealthy') {
              console.log('Status is not unhealthy, skipping issue creation');
              return;
            }
            
            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-monitor,automated'
            });
            
            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `## Health Check Update\n\n**Time:** ${new Date().toISOString()}\n**Status:** ${status}\n**Unhealthy Services:** ${unhealthy}\n\nSelf-healing actions were attempted.`
              });
              console.log('Updated existing issue #' + issues[0].number);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ System Health Alert - Automated Detection',
                body: `## Automated Health Alert\n\n**Detected:** ${new Date().toISOString()}\n**Status:** ${status}\n**Unhealthy Services:** ${unhealthy}\n\n### What Happened\nThe automated health monitor detected issues with the following services:\n- ${unhealthy.split(',').join('\n- ')}\n\n### Self-Healing Actions\nAutomated healing actions were attempted. Check the workflow run for details.\n\n### Next Steps\n1. Check the [Health Monitor workflow](../../actions/workflows/health-monitor.yml) for details\n2. Verify the affected services manually\n3. Close this issue when resolved\n\n---\n*This issue was automatically created by the Health Monitor workflow.*`,
                labels: ['health-monitor', 'automated', 'bug']
              });
              console.log('Created new health alert issue');
            }
